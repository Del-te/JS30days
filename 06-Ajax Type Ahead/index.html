<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ajax Type Ahead ğŸ‘€</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <form class="search-form">
      <input type="text" class="search" placeholder="è¯—å¥ è¯—å è¯—äºº" />
      <ul class="suggestions">
        <li>è¾“å…¥è¯å¥ï¼Œæ‰¾ä¸€é¦–è¯—</li>
        <li></li>
      </ul>
    </form>
    <script>
      // 2 begin
      // è·å–è¯—å¥åº“json
      const endpoint =
        "https://gist.githubusercontent.com/soyaine/81399bb2b24ca1bb5313e1985533c640/raw/bdf7df2cbcf70706c4a5e51a7dfb8c933ed78878/TangPoetry.json";
      // æœç´¢ç»“æœ
      const poetrys = [];
      // å¼‚æ­¥é€šè®¯
      fetch(endpoint)
        .then((blob) => blob.json())
        .then((data) => poetrys.push(...data));
      // 2 end

      // 3 begin
      function findMatches(word, poetrys) {
        // ç”¨æ•°ç»„æ–¹æ³•filterè¿›è¡Œæœç´¢
        return poetrys.filter((poet) => {
          // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…
          const regex = new RegExp(word, "gi");
          // æ•°ç»„æ–¹æ³•join()å°†æ•°ç»„ç²˜åˆä¸ºå­—ç¬¦ä¸²
          const author = poet.detail_author.join("");
          return (
            // åœ¨å¤è¯—è¯—å¥ã€æ ‡é¢˜ã€ä½œè€…è¿›è¡ŒåŒ¹é…
            poet.detail_text.match(regex) ||
            poet.title.match(regex) ||
            author.match(regex)
          );
        })
      }
      function displayMatches() {
        const matches = findMatches(this.value, poetrys);
        const regex = new RegExp(this.value, "gi");
        // æ•°ç»„æ–¹æ³•map()å¯¹æ•°ç»„è¿›è¡ŒæŒ‡å®šæ–¹æ³•æ˜ å°„å¤„ç†
        const html = matches
          .map((poet) => {
            const text = poet.detail_text.replace(
              regex,
              `<span class="hl">${this.value}</span>`
            );
            const title = poet.title.replace(
              regex,
              `<span class="hl">${this.value}</span>`
            );
            return `
              <li>
                <span class="poet">${text}</span>
                <span class="title">${title} - ${poet.detail_author[0]}</span>
              </li>
            `;
          })
          .join("");
        // æ˜¾ç¤ºæ›¿æ¢ç»“æœ
        suggestions.innerHTML = html;
      }
      // 1 begin
      // è·å–æœç´¢æ¡†
      const search = document.querySelector(".search");
      // è·å–æœç´¢ç»“æœæ¡†
      const suggestions = document.querySelector(".suggestions");
      // ç›‘å¬äº‹ä»¶
      search.addEventListener("change", displayMatches);
      search.addEventListener("keyup", displayMatches);
      // 1 end
    </script>
  </body>
</html>
